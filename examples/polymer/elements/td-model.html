<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="td-model">
	<template>
		<iron-localstorage name="todos-polymer" value="{{items}}" on-iron-localstorage-load-empty="initializeDefaultTodos"></iron-localstorage>
	</template>
	<script>
		Polymer({
			is: 'td-model',
			properties: {
				filter: String,
				items: {
					type: Array,
					notify: true,
					value: function() {
						return []
					}
				}
			},
			newItem: function(title) {
				title = String(title).trim();
				if (title) {
					var item = {
						title: title,
						completed: false
					};
					this.push('items', item);
					this.notifyPath('items', this.items);
					this.itemsChanged();
				}
			},
			filtered: null,
			completedCount: 0,
			activeCount: 0,
			allCompleted: false,
			filterChanged: function() {
				this.async(function() {
					this.filterItems();
				});
			},
			initializeDefaultTodos: function() {
				this.items = [];
			},
			itemsChanged: function() {
				this.completedCount = this.items.filter(this.filters.completed).length;
				this.activeCount = this.items.length - this.completedCount;
				this.allCompleted = this.completedCount && !this.activeCount;
				this.filterItems();
			},
			filterItems: function() {
				var fn = this.filters[this.filter];
				this.filtered = fn ? this.items.filter(fn) : this.items;
			},
			destroyItem: function(item) {
				var i = this.items.indexOf(item);
				if (i >= 0) {
					this.items.splice(i, 1);
				}
				this.itemsChanged();
			},
			clearItems: function (){
				this.items = this.items.filter(this.filters.active);
			},
			setItemsCompleted: function(completed) {
				this.items.forEach(function(item) {
					item.completed = completed;
				});
				this.itemsChanged();
			},
			filters: {
				active: function(item) {
					return !item.completed;
				},
				completed: function(item) {
					return item.completed;
				}
			}
		});
	</script>
</dom-module>
